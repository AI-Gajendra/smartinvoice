{% extends 'base_new.html' %}

{% block title %}Create Invoice - Smart iInvoice{% endblock %}

{% block header_actions %}
<div class="flex items-center gap-3">
    <!-- Save as Draft Button -->
    <button type="button" onclick="saveAsDraft()" 
            class="px-5 py-2.5 glass-panel text-gray-600 rounded-xl text-sm font-bold hover:bg-white/60 transition-colors shadow-sm flex items-center gap-2">
        <i class="fa-solid fa-floppy-disk text-primary"></i> Save as Draft
    </button>
    <!-- Send Invoice Button -->
    <button type="button" onclick="sendInvoice()" 
            class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-2xl font-semibold shadow-lg shadow-primary/20 hover:shadow-primary/40 hover:scale-105 transition-all transform flex items-center gap-2">
        <i class="fa-solid fa-paper-plane"></i>
        <span>Send Invoice</span>
    </button>
</div>
{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <!-- Back Button -->
    <div class="mb-6">
        <a href="{% url 'invoices_new' %}" class="inline-flex items-center text-sm text-primary hover:text-secondary font-medium transition-colors">
            <i class="fa-solid fa-arrow-left mr-2"></i>Back to Invoices
        </a>
    </div>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-10">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Create New Invoice</h1>
            <p class="text-gray-500 mt-2 font-medium">Fill in the details to create a new invoice.</p>
        </div>
    </div>

    <!-- Invoice Form -->
    <form id="invoice-form" method="post" action="{% url 'invoice_create' %}">
        {% csrf_token %}
        <input type="hidden" name="action" id="form-action" value="draft">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Client & Invoice Details -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Client Information Section (9.2) -->
                <div class="glass-panel rounded-3xl p-6 animate-slide-in">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
                            <i class="fa-solid fa-building text-primary"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Client Information</h2>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Client Name Dropdown -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-user mr-2 text-primary/60"></i>Client Name
                            </label>
                            <div class="relative">
                                <select name="client_id" id="client-select" 
                                        class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 appearance-none cursor-pointer">
                                    <option value="">Select a client...</option>
                                    {% for client in clients %}
                                    <option value="{{ client.id }}" data-email="{{ client.email|default:'' }}" data-address="{{ client.address|default:'' }}">
                                        {{ client.name }}
                                    </option>
                                    {% empty %}
                                    <!-- Sample clients for demo -->
                                    <option value="new">+ Add New Client</option>
                                    {% endfor %}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                    <i class="fa-solid fa-chevron-down text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Contact Person -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-id-card mr-2 text-primary/60"></i>Contact Person
                            </label>
                            <input type="text" name="contact_person" id="contact-person"
                                   placeholder="Enter contact person name"
                                   class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700">
                        </div>
                        
                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-envelope mr-2 text-primary/60"></i>Email
                            </label>
                            <input type="email" name="client_email" id="client-email"
                                   placeholder="client@example.com"
                                   class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700">
                        </div>
                        
                        <!-- Billing Address -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-location-dot mr-2 text-primary/60"></i>Billing Address
                            </label>
                            <textarea name="billing_address" id="billing-address" rows="3"
                                      placeholder="Enter billing address"
                                      class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700 resize-none"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Invoice Details Section (9.3) -->
                <div class="glass-panel rounded-3xl p-6 animate-slide-in" style="animation-delay: 0.1s;">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
                            <i class="fa-solid fa-file-invoice text-primary"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Invoice Details</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Invoice Number (Auto-generated) -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-hashtag mr-2 text-primary/60"></i>Invoice Number
                            </label>
                            <input type="text" name="invoice_number" id="invoice-number"
                                   value="INV-{{ next_invoice_number|default:'00001' }}"
                                   class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 bg-white/30"
                                   readonly>
                            <p class="text-xs text-gray-400 mt-1">Auto-generated invoice number</p>
                        </div>
                        
                        <!-- Invoice Date -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-calendar mr-2 text-primary/60"></i>Invoice Date
                            </label>
                            <input type="date" name="invoice_date" id="invoice-date"
                                   value="{{ today|date:'Y-m-d' }}"
                                   class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700">
                        </div>
                        
                        <!-- Due Date -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-calendar-check mr-2 text-primary/60"></i>Due Date
                            </label>
                            <input type="date" name="due_date" id="due-date"
                                   class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700">
                        </div>
                        
                        <!-- Payment Terms -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-clock mr-2 text-primary/60"></i>Payment Terms
                            </label>
                            <div class="relative">
                                <select name="payment_terms" id="payment-terms"
                                        class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 appearance-none cursor-pointer"
                                        onchange="updateDueDate()">
                                    <option value="immediate">Due on Receipt</option>
                                    <option value="net15">Net 15</option>
                                    <option value="net30" selected>Net 30</option>
                                    <option value="net45">Net 45</option>
                                    <option value="net60">Net 60</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                    <i class="fa-solid fa-chevron-down text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Currency -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-indian-rupee-sign mr-2 text-primary/60"></i>Currency
                            </label>
                            <div class="relative">
                                <select name="currency" id="currency"
                                        class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 appearance-none cursor-pointer">
                                    <option value="INR" selected>₹ INR - Indian Rupee</option>
                                    <option value="USD">$ USD - US Dollar</option>
                                    <option value="EUR">€ EUR - Euro</option>
                                    <option value="GBP">£ GBP - British Pound</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-4 pointer-events-none">
                                    <i class="fa-solid fa-chevron-down text-gray-400"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vendor GSTIN -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                <i class="fa-solid fa-id-badge mr-2 text-primary/60"></i>Vendor GSTIN
                            </label>
                            <input type="text" name="vendor_gstin" id="vendor-gstin"
                                   placeholder="e.g., 22AAAAA0000A1Z5"
                                   maxlength="15"
                                   class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700 uppercase">
                        </div>
                    </div>
                </div>


                <!-- Itemized List Section (9.4) -->
                <div class="glass-panel rounded-3xl p-6 animate-slide-in" style="animation-delay: 0.2s;">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
                                <i class="fa-solid fa-list text-primary"></i>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold text-gray-900">Itemized List</h2>
                                <p class="text-sm text-gray-500" id="item-count">0 items</p>
                            </div>
                        </div>
                        <!-- Add New Item Button (9.5) -->
                        <button type="button" onclick="addLineItem()"
                                class="px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-xl text-sm font-bold shadow-md shadow-primary/20 hover:shadow-primary/40 hover:scale-105 transition-all flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <!-- Line Items Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse" id="line-items-table">
                            <thead>
                                <tr class="bg-white/20 text-xs uppercase tracking-wider text-gray-500 font-bold">
                                    <th class="px-4 py-3 w-8">#</th>
                                    <th class="px-4 py-3">Description</th>
                                    <th class="px-4 py-3 w-24">HSN/SAC</th>
                                    <th class="px-4 py-3 w-20 text-right">Qty</th>
                                    <th class="px-4 py-3 w-28 text-right">Unit Price</th>
                                    <th class="px-4 py-3 w-20 text-right">Tax %</th>
                                    <th class="px-4 py-3 w-28 text-right">Subtotal</th>
                                    <th class="px-4 py-3 w-12"></th>
                                </tr>
                            </thead>
                            <tbody id="line-items-body" class="divide-y divide-white/40">
                                <!-- Line items will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="empty-items-state" class="text-center py-12">
                        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-primary/10 to-secondary/10 flex items-center justify-center">
                            <i class="fa-solid fa-box-open text-primary text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-gray-900 mb-2">No Items Added</h3>
                        <p class="text-gray-500 mb-4">Click "Add Item" to add line items to this invoice.</p>
                        <button type="button" onclick="addLineItem()"
                                class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-xl text-sm font-bold shadow-md shadow-primary/20 hover:shadow-primary/40 transition-all">
                            <i class="fa-solid fa-plus mr-2"></i> Add First Item
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right Column: Summary & Totals (9.6) -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Invoice Summary -->
                <div class="glass-panel rounded-3xl p-6 animate-slide-in sticky top-8" style="animation-delay: 0.3s;">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
                            <i class="fa-solid fa-calculator text-primary"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Invoice Summary</h2>
                    </div>
                    
                    <div class="space-y-4">
                        <!-- Subtotal -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Subtotal</span>
                            <span class="text-sm font-bold text-gray-900" id="subtotal-display">₹0.00</span>
                            <input type="hidden" name="subtotal" id="subtotal-input" value="0">
                        </div>
                        
                        <!-- Tax Total -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Tax (GST)</span>
                            <span class="text-sm font-bold text-gray-900" id="tax-display">₹0.00</span>
                            <input type="hidden" name="tax_total" id="tax-input" value="0">
                        </div>
                        
                        <!-- Discount -->
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Discount</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-400">-</span>
                                <input type="number" name="discount" id="discount-input" 
                                       value="0" min="0" step="0.01"
                                       onchange="calculateTotals()"
                                       class="w-24 px-3 py-1.5 glass-panel rounded-lg text-sm text-right focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700">
                            </div>
                        </div>
                        
                        <!-- Divider -->
                        <div class="border-t border-white/40 pt-4">
                            <!-- Grand Total -->
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-900">Grand Total</span>
                                <span class="text-2xl font-bold text-primary" id="grand-total-display">₹0.00</span>
                                <input type="hidden" name="grand_total" id="grand-total-input" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons for Mobile -->
                    <div class="mt-8 space-y-3 lg:hidden">
                        <button type="button" onclick="saveAsDraft()"
                                class="w-full px-5 py-3 glass-panel text-gray-600 rounded-xl text-sm font-bold hover:bg-white/60 transition-colors shadow-sm flex items-center justify-center gap-2">
                            <i class="fa-solid fa-floppy-disk text-primary"></i> Save as Draft
                        </button>
                        <button type="button" onclick="sendInvoice()"
                                class="w-full px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-2xl font-semibold shadow-lg shadow-primary/20 hover:shadow-primary/40 transition-all flex items-center justify-center gap-2">
                            <i class="fa-solid fa-paper-plane"></i> Send Invoice
                        </button>
                    </div>
                </div>
                
                <!-- Notes Section -->
                <div class="glass-panel rounded-3xl p-6 animate-slide-in" style="animation-delay: 0.4s;">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-primary/20 to-secondary/20 flex items-center justify-center">
                            <i class="fa-solid fa-sticky-note text-primary"></i>
                        </div>
                        <h2 class="text-lg font-bold text-gray-900">Notes</h2>
                    </div>
                    <textarea name="notes" id="notes" rows="4"
                              placeholder="Add any notes or payment instructions..."
                              class="w-full px-4 py-3 glass-panel rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700 resize-none"></textarea>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Line item counter
    let lineItemCount = 0;
    
    // Currency symbol based on selection
    function getCurrencySymbol() {
        const currency = document.getElementById('currency').value;
        const symbols = { 'INR': '₹', 'USD': '$', 'EUR': '€', 'GBP': '£' };
        return symbols[currency] || '₹';
    }
    
    // Format currency
    function formatCurrency(amount) {
        return getCurrencySymbol() + parseFloat(amount).toFixed(2);
    }
    
    // Add new line item (9.5)
    function addLineItem() {
        lineItemCount++;
        const tbody = document.getElementById('line-items-body');
        const emptyState = document.getElementById('empty-items-state');
        
        // Hide empty state
        emptyState.classList.add('hidden');
        
        const row = document.createElement('tr');
        row.className = 'hover:bg-white/30 transition-colors line-item-row';
        row.id = `line-item-${lineItemCount}`;
        row.innerHTML = `
            <td class="px-4 py-3 text-sm text-gray-500 font-medium">${lineItemCount}</td>
            <td class="px-4 py-3">
                <input type="text" name="items[${lineItemCount}][description]" 
                       placeholder="Item description"
                       class="w-full px-3 py-2 glass-panel rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700"
                       required>
            </td>
            <td class="px-4 py-3">
                <input type="text" name="items[${lineItemCount}][hsn_sac]" 
                       placeholder="HSN/SAC"
                       class="w-full px-3 py-2 glass-panel rounded-lg text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all placeholder-gray-400 text-gray-700">
            </td>
            <td class="px-4 py-3">
                <input type="number" name="items[${lineItemCount}][quantity]" 
                       value="1" min="0.01" step="0.01"
                       onchange="calculateLineTotal(${lineItemCount})"
                       class="w-full px-3 py-2 glass-panel rounded-lg text-sm text-right focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 line-qty"
                       required>
            </td>
            <td class="px-4 py-3">
                <input type="number" name="items[${lineItemCount}][unit_price]" 
                       value="0" min="0" step="0.01"
                       onchange="calculateLineTotal(${lineItemCount})"
                       class="w-full px-3 py-2 glass-panel rounded-lg text-sm text-right focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 line-price"
                       required>
            </td>
            <td class="px-4 py-3">
                <input type="number" name="items[${lineItemCount}][tax_rate]" 
                       value="18" min="0" max="100" step="0.01"
                       onchange="calculateLineTotal(${lineItemCount})"
                       class="w-full px-3 py-2 glass-panel rounded-lg text-sm text-right focus:ring-2 focus:ring-primary/20 focus:bg-white/60 transition-all text-gray-700 line-tax">
            </td>
            <td class="px-4 py-3 text-right">
                <span class="text-sm font-bold text-gray-900 line-subtotal" id="line-subtotal-${lineItemCount}">${formatCurrency(0)}</span>
                <input type="hidden" name="items[${lineItemCount}][subtotal]" id="line-subtotal-input-${lineItemCount}" value="0">
            </td>
            <td class="px-4 py-3">
                <button type="button" onclick="removeLineItem(${lineItemCount})"
                        class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:text-error hover:bg-error/10 transition-colors">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
        updateItemCount();
        calculateTotals();
    }
    
    // Remove line item
    function removeLineItem(itemId) {
        const row = document.getElementById(`line-item-${itemId}`);
        if (row) {
            row.remove();
            updateItemCount();
            calculateTotals();
            
            // Show empty state if no items
            const rows = document.querySelectorAll('.line-item-row');
            if (rows.length === 0) {
                document.getElementById('empty-items-state').classList.remove('hidden');
            }
        }
    }
    
    // Calculate line total
    function calculateLineTotal(itemId) {
        const row = document.getElementById(`line-item-${itemId}`);
        if (!row) return;
        
        const qty = parseFloat(row.querySelector('.line-qty').value) || 0;
        const price = parseFloat(row.querySelector('.line-price').value) || 0;
        const taxRate = parseFloat(row.querySelector('.line-tax').value) || 0;
        
        const subtotal = qty * price;
        const taxAmount = subtotal * (taxRate / 100);
        const lineTotal = subtotal + taxAmount;
        
        document.getElementById(`line-subtotal-${itemId}`).textContent = formatCurrency(lineTotal);
        document.getElementById(`line-subtotal-input-${itemId}`).value = lineTotal.toFixed(2);
        
        calculateTotals();
    }
    
    // Calculate all totals (9.6)
    function calculateTotals() {
        const rows = document.querySelectorAll('.line-item-row');
        let subtotal = 0;
        let taxTotal = 0;
        
        rows.forEach(row => {
            const qty = parseFloat(row.querySelector('.line-qty').value) || 0;
            const price = parseFloat(row.querySelector('.line-price').value) || 0;
            const taxRate = parseFloat(row.querySelector('.line-tax').value) || 0;
            
            const lineSubtotal = qty * price;
            const lineTax = lineSubtotal * (taxRate / 100);
            
            subtotal += lineSubtotal;
            taxTotal += lineTax;
        });
        
        const discount = parseFloat(document.getElementById('discount-input').value) || 0;
        const grandTotal = subtotal + taxTotal - discount;
        
        // Update displays
        document.getElementById('subtotal-display').textContent = formatCurrency(subtotal);
        document.getElementById('tax-display').textContent = formatCurrency(taxTotal);
        document.getElementById('grand-total-display').textContent = formatCurrency(grandTotal);
        
        // Update hidden inputs
        document.getElementById('subtotal-input').value = subtotal.toFixed(2);
        document.getElementById('tax-input').value = taxTotal.toFixed(2);
        document.getElementById('grand-total-input').value = grandTotal.toFixed(2);
    }
    
    // Update item count display
    function updateItemCount() {
        const count = document.querySelectorAll('.line-item-row').length;
        document.getElementById('item-count').textContent = `${count} item${count !== 1 ? 's' : ''}`;
    }
    
    // Update due date based on payment terms
    function updateDueDate() {
        const terms = document.getElementById('payment-terms').value;
        const invoiceDate = new Date(document.getElementById('invoice-date').value);
        const dueDateInput = document.getElementById('due-date');
        
        if (isNaN(invoiceDate.getTime())) return;
        
        let daysToAdd = 0;
        switch (terms) {
            case 'immediate': daysToAdd = 0; break;
            case 'net15': daysToAdd = 15; break;
            case 'net30': daysToAdd = 30; break;
            case 'net45': daysToAdd = 45; break;
            case 'net60': daysToAdd = 60; break;
            case 'custom': return; // Don't auto-update for custom
        }
        
        const dueDate = new Date(invoiceDate);
        dueDate.setDate(dueDate.getDate() + daysToAdd);
        dueDateInput.value = dueDate.toISOString().split('T')[0];
    }
    
    // Save as Draft (9.7)
    function saveAsDraft() {
        document.getElementById('form-action').value = 'draft';
        
        // Validate at least basic info
        const form = document.getElementById('invoice-form');
        if (validateForm()) {
            form.submit();
        }
    }
    
    // Send Invoice (9.8)
    function sendInvoice() {
        document.getElementById('form-action').value = 'send';
        
        // Validate form
        const form = document.getElementById('invoice-form');
        if (validateForm(true)) {
            form.submit();
        }
    }
    
    // Form validation
    function validateForm(requireItems = false) {
        const invoiceNumber = document.getElementById('invoice-number').value;
        const invoiceDate = document.getElementById('invoice-date').value;
        
        if (!invoiceNumber) {
            showError('Invoice number is required');
            return false;
        }
        
        if (!invoiceDate) {
            showError('Invoice date is required');
            return false;
        }
        
        if (requireItems) {
            const rows = document.querySelectorAll('.line-item-row');
            if (rows.length === 0) {
                showError('Please add at least one line item');
                return false;
            }
            
            // Validate each line item has description
            let valid = true;
            rows.forEach(row => {
                const desc = row.querySelector('input[name*="description"]').value;
                if (!desc.trim()) {
                    valid = false;
                }
            });
            
            if (!valid) {
                showError('All line items must have a description');
                return false;
            }
        }
        
        return true;
    }
    
    // Show error message
    function showError(message) {
        alert(message); // Simple alert for now, can be replaced with toast
    }
    
    // Client selection handler
    document.getElementById('client-select')?.addEventListener('change', function() {
        const selected = this.options[this.selectedIndex];
        if (selected.value === 'new') {
            // Redirect to add client page or show modal
            window.location.href = "{% url 'clients_new' %}";
            return;
        }
        
        // Auto-fill client details
        const email = selected.dataset.email || '';
        const address = selected.dataset.address || '';
        
        document.getElementById('client-email').value = email;
        document.getElementById('billing-address').value = address;
    });
    
    // Currency change handler
    document.getElementById('currency')?.addEventListener('change', function() {
        calculateTotals();
        // Update all line subtotals display
        document.querySelectorAll('.line-item-row').forEach((row, index) => {
            const subtotalSpan = row.querySelector('.line-subtotal');
            const subtotalInput = row.querySelector('input[name*="subtotal"]');
            if (subtotalSpan && subtotalInput) {
                subtotalSpan.textContent = formatCurrency(parseFloat(subtotalInput.value) || 0);
            }
        });
    });
    
    // Invoice date change handler
    document.getElementById('invoice-date')?.addEventListener('change', updateDueDate);
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Set default due date (30 days from today)
        updateDueDate();
    });
</script>
{% endblock %}
