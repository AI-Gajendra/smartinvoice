{% extends 'base_new.html' %}
{% load static %}

{% block title %}GST Verification - Smart iInvoice{% endblock %}

{% block header_actions %}
<button id="upload-btn" class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-2xl font-semibold shadow-lg shadow-primary/20 hover:shadow-primary/40 hover:scale-105 transition-all transform flex items-center gap-2">
    <i class="fa-solid fa-upload"></i>
    <span>Upload Invoice</span>
</button>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-8 animate-fade-in">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 tracking-tight">GST Verification</h1>
        <p class="text-gray-500 mt-2 font-medium">Verify vendor GST numbers with government portal</p>
    </div>
    <div class="flex items-center gap-3">
        <div class="glass-panel px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-medium text-gray-600">
            <i class="fa-solid fa-list text-primary"></i>
            <span>Total: {{ total_count }} invoice{{ total_count|pluralize }}</span>
        </div>
        <a href="{% url 'export_invoices' %}?status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
           class="glass-panel px-4 py-2 rounded-xl flex items-center gap-2 text-sm font-semibold text-success hover:bg-success/10 transition-colors">
            <i class="fa-solid fa-download"></i>
            <span>Export CSV</span>
        </a>
    </div>
</div>

<!-- Filter Controls -->
<div class="glass-panel p-6 rounded-3xl mb-8 animate-slide-in">
    <!-- GST Status Filter -->
    <div class="mb-6">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 block">GST Verification Status</label>
        <div class="flex flex-wrap gap-2">
            <a href="?status=all&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if current_filter == 'all' %}bg-gradient-to-r from-primary to-secondary text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-list mr-2"></i>All
            </a>
            <a href="?status=pending&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if current_filter == 'pending' %}bg-gradient-to-r from-warning to-orange-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-clock mr-2"></i>Pending
            </a>
            <a href="?status=verified&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if current_filter == 'verified' %}bg-gradient-to-r from-success to-green-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-check-circle mr-2"></i>Verified
            </a>
            <a href="?status=failed&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if current_filter == 'failed' %}bg-gradient-to-r from-error to-red-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-times-circle mr-2"></i>Failed
            </a>
        </div>
    </div>

    <!-- Health Score Filter -->
    <div class="mb-6">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 block">Health Score Status</label>
        <div class="flex flex-wrap gap-2">
            <a href="?status={{ current_filter }}&health=all&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if health_filter == 'all' %}bg-gradient-to-r from-primary to-secondary text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-list mr-2"></i>All
            </a>
            <a href="?status={{ current_filter }}&health=healthy&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if health_filter == 'healthy' %}bg-gradient-to-r from-success to-green-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-check-circle mr-2"></i>Healthy
            </a>
            <a href="?status={{ current_filter }}&health=review&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if health_filter == 'review' %}bg-gradient-to-r from-warning to-orange-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-exclamation-circle mr-2"></i>Review
            </a>
            <a href="?status={{ current_filter }}&health=at_risk&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if health_filter == 'at_risk' %}bg-gradient-to-r from-error to-red-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-times-circle mr-2"></i>At Risk
            </a>
        </div>
    </div>

    <!-- AI Confidence Filter -->
    <div class="mb-6">
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 block">AI Confidence Level</label>
        <div class="flex flex-wrap gap-2">
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence=all&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if confidence_filter == 'all' %}bg-gradient-to-r from-primary to-secondary text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-list mr-2"></i>All
            </a>
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence=high&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if confidence_filter == 'high' %}bg-gradient-to-r from-success to-green-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-thumbs-up mr-2"></i>High (≥80%)
            </a>
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence=medium&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if confidence_filter == 'medium' %}bg-gradient-to-r from-warning to-orange-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-hand mr-2"></i>Medium (50-79%)
            </a>
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence=low&sort={{ sort_by }}" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if confidence_filter == 'low' %}bg-gradient-to-r from-error to-red-400 text-white shadow-md{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-thumbs-down mr-2"></i>Low (<50%)
            </a>
        </div>
    </div>

    <!-- Sort Options -->
    <div>
        <label class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-3 block">Sort By</label>
        <div class="flex flex-wrap gap-2">
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort=date" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if sort_by == 'date' %}bg-gray-800 text-white{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-calendar mr-2"></i>Date
            </a>
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort=health_desc" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if sort_by == 'health_desc' %}bg-gray-800 text-white{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-arrow-down mr-2"></i>Health ↓
            </a>
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort=health_asc" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if sort_by == 'health_asc' %}bg-gray-800 text-white{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-arrow-up mr-2"></i>Health ↑
            </a>
            <a href="?status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort=confidence_desc" 
               class="px-4 py-2 rounded-xl text-sm font-semibold transition-all {% if sort_by == 'confidence_desc' %}bg-gray-800 text-white{% else %}bg-white/50 text-gray-600 hover:bg-white/80{% endif %}">
                <i class="fa-solid fa-arrow-down mr-2"></i>Confidence ↓
            </a>
        </div>
    </div>
</div>

<!-- Invoice Table -->
<div class="glass-panel rounded-3xl overflow-hidden animate-slide-in" style="animation-delay: 0.1s;">
    {% if page_obj.object_list %}
    <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse">
            <thead>
                <tr class="bg-white/20 text-xs uppercase tracking-wider text-gray-500 font-bold">
                    <th class="px-6 py-5">Invoice</th>
                    <th class="px-6 py-5 hidden sm:table-cell">Vendor</th>
                    <th class="px-6 py-5 hidden md:table-cell">GSTIN</th>
                    <th class="px-6 py-5 hidden lg:table-cell">Date</th>
                    <th class="px-6 py-5 hidden xl:table-cell">Health</th>
                    <th class="px-6 py-5 hidden 2xl:table-cell">AI Confidence</th>
                    <th class="px-6 py-5">Status</th>
                    <th class="px-6 py-5">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/40">
                {% for invoice in page_obj.object_list %}
                <tr class="hover:bg-white/30 transition-colors cursor-pointer" onclick="window.location.href='{% url 'invoice_detail' invoice.id %}'">
                    <td class="px-6 py-5">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full flex-shrink-0
                                {% if invoice.gst_verification_status == 'VERIFIED' %}bg-success
                                {% elif invoice.gst_verification_status == 'FAILED' %}bg-error
                                {% else %}bg-warning animate-pulse{% endif %}">
                            </div>
                            <div>
                                <span class="text-sm font-bold text-gray-900">{{ invoice.invoice_id|default:"N/A" }}</span>
                                {% if invoice.duplicate_link %}
                                <span class="ml-2 text-[10px] font-bold bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">DUP</span>
                                {% endif %}
                                <div class="text-xs text-gray-500 sm:hidden mt-1">{{ invoice.vendor_name|truncatechars:20 }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-5 hidden sm:table-cell">
                        <span class="text-sm font-medium text-gray-900">{{ invoice.vendor_name|truncatechars:25 }}</span>
                    </td>
                    <td class="px-6 py-5 hidden md:table-cell">
                        <span class="text-sm font-mono bg-white/50 px-2 py-1 rounded-lg text-gray-700">{{ invoice.vendor_gstin|default:"N/A" }}</span>
                    </td>
                    <td class="px-6 py-5 hidden lg:table-cell">
                        <span class="text-sm text-gray-500 font-medium">{{ invoice.invoice_date|date:"M d, Y"|default:"N/A" }}</span>
                    </td>
                    <td class="px-6 py-5 hidden xl:table-cell">
                        {% if invoice.health_score %}
                        <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold border
                            {% if invoice.health_score.status == 'HEALTHY' %}bg-success/10 text-success border-success/20
                            {% elif invoice.health_score.status == 'REVIEW' %}bg-warning/10 text-warning border-warning/20
                            {% else %}bg-error/10 text-error border-error/20{% endif %}">
                            {% if invoice.health_score.status == 'HEALTHY' %}<i class="fa-solid fa-check-circle mr-1"></i>
                            {% elif invoice.health_score.status == 'REVIEW' %}<i class="fa-solid fa-exclamation-circle mr-1"></i>
                            {% else %}<i class="fa-solid fa-times-circle mr-1"></i>{% endif %}
                            {{ invoice.health_score.overall_score }}
                        </span>
                        {% else %}
                        <span class="text-xs text-gray-400">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-5 hidden 2xl:table-cell">
                        {% if invoice.ai_confidence_score %}
                        <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold border
                            {% if invoice.ai_confidence_score >= 80 %}bg-success/10 text-success border-success/20
                            {% elif invoice.ai_confidence_score >= 50 %}bg-warning/10 text-warning border-warning/20
                            {% else %}bg-error/10 text-error border-error/20{% endif %}">
                            {{ invoice.ai_confidence_score|floatformat:0 }}%
                        </span>
                        {% else %}
                        <span class="text-xs text-gray-400">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-5">
                        <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold border
                            {% if invoice.gst_verification_status == 'VERIFIED' %}bg-success/10 text-success border-success/20
                            {% elif invoice.gst_verification_status == 'FAILED' %}bg-error/10 text-error border-error/20
                            {% else %}bg-warning/10 text-warning border-warning/20{% endif %}">
                            {% if invoice.gst_verification_status == 'VERIFIED' %}<i class="fa-solid fa-check-circle mr-1"></i>Verified
                            {% elif invoice.gst_verification_status == 'FAILED' %}<i class="fa-solid fa-times-circle mr-1"></i>Failed
                            {% else %}<i class="fa-solid fa-clock mr-1"></i>Pending{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-5">
                        {% if invoice.gst_verification_status == 'PENDING' and invoice.vendor_gstin %}
                        <button onclick="event.stopPropagation(); startVerification({{ invoice.id }}, '{{ invoice.vendor_gstin }}')" 
                                class="px-4 py-2 bg-gradient-to-r from-primary to-secondary text-white rounded-xl text-sm font-semibold hover:shadow-lg transition-all">
                            <i class="fa-solid fa-shield-alt mr-1"></i>Verify
                        </button>
                        {% elif not invoice.vendor_gstin %}
                        <span class="text-xs text-gray-400 bg-white/50 px-3 py-1 rounded-lg">No GSTIN</span>
                        {% else %}
                        <span class="text-xs text-gray-500 bg-white/50 px-3 py-1 rounded-lg">
                            <i class="fa-solid fa-check mr-1"></i>Done
                        </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="p-6 border-t border-white/40 flex flex-col sm:flex-row items-center justify-between gap-4">
        <p class="text-sm text-gray-500">
            Showing <span class="font-bold text-gray-700">{{ page_obj.start_index }}</span> to 
            <span class="font-bold text-gray-700">{{ page_obj.end_index }}</span> of 
            <span class="font-bold text-gray-700">{{ page_obj.paginator.count }}</span> results
        </p>
        <nav class="flex items-center gap-2">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}&status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="w-10 h-10 rounded-xl bg-white/50 flex items-center justify-center text-gray-600 hover:bg-white/80 transition-colors">
                <i class="fa-solid fa-chevron-left"></i>
            </a>
            {% endif %}
            
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <span class="w-10 h-10 rounded-xl bg-primary text-white flex items-center justify-center font-bold">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <a href="?page={{ num }}&status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
                   class="w-10 h-10 rounded-xl bg-white/50 flex items-center justify-center text-gray-600 hover:bg-white/80 transition-colors font-medium">{{ num }}</a>
                {% endif %}
            {% endfor %}
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}&status={{ current_filter }}&health={{ health_filter }}&confidence={{ confidence_filter }}&sort={{ sort_by }}" 
               class="w-10 h-10 rounded-xl bg-white/50 flex items-center justify-center text-gray-600 hover:bg-white/80 transition-colors">
                <i class="fa-solid fa-chevron-right"></i>
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
    {% else %}
    <!-- Empty State -->
    <div class="text-center py-16">
        <div class="w-20 h-20 mx-auto rounded-3xl bg-gray-100 flex items-center justify-center text-gray-400 mb-6">
            <i class="fa-solid fa-file-invoice text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">No invoices found</h3>
        <p class="text-gray-500 mb-6">
            {% if current_filter != 'all' %}
            No invoices match the selected filter. <a href="?status=all" class="text-primary hover:underline font-medium">View all invoices</a>
            {% else %}
            Upload some invoices to get started with GST verification.
            {% endif %}
        </p>
        <button id="empty-upload-btn" class="px-6 py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-2xl font-semibold shadow-lg hover:shadow-xl transition-all">
            <i class="fa-solid fa-upload mr-2"></i>Upload Invoice
        </button>
    </div>
    {% endif %}
</div>


<!-- Upload Modal -->
<div id="upload-modal" class="fixed inset-0 bg-gray-900/70 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-3xl animate-slide-in p-6 shadow-2xl">
        <!-- Modal Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-xl font-bold text-gray-900">Upload Invoice</h3>
                <p class="text-sm text-gray-500 mt-1">Upload your invoice for automated processing</p>
            </div>
            <button id="close-modal" class="w-10 h-10 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-800 flex items-center justify-center transition-colors">
                <i class="fa-solid fa-times text-lg"></i>
            </button>
        </div>
        
        <!-- Upload Area -->
        <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-primary hover:bg-white/30 transition-all cursor-pointer group">
            <div id="upload-content">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                    <i class="fa-solid fa-cloud-upload-alt text-2xl text-white"></i>
                </div>
                <p class="text-base text-gray-700 mb-2 font-medium">
                    <span class="text-primary font-bold">Click to upload</span> or drag and drop
                </p>
                <p class="text-sm text-gray-500">PNG, JPG, JPEG or PDF (max. 10MB)</p>
            </div>
            
            <!-- Loading State -->
            <div id="upload-loading" class="hidden">
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-2 border-white border-t-transparent"></div>
                    </div>
                    <p class="text-sm font-medium text-gray-700">Processing invoice...</p>
                    <p class="text-xs text-gray-500 mt-1">This may take a few moments</p>
                </div>
            </div>
            
            <!-- Success State -->
            <div id="upload-success" class="hidden">
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 mx-auto mb-4 bg-success/10 rounded-2xl flex items-center justify-center">
                        <i class="fa-solid fa-check-circle text-3xl text-success"></i>
                    </div>
                    <p class="text-sm font-bold text-gray-900">Invoice uploaded successfully!</p>
                    <p class="text-xs text-gray-500 mt-1">Redirecting to invoice details...</p>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="upload-error" class="hidden">
                <div class="flex flex-col items-center">
                    <div class="w-16 h-16 mx-auto mb-4 bg-error/10 rounded-2xl flex items-center justify-center">
                        <i class="fa-solid fa-exclamation-circle text-3xl text-error"></i>
                    </div>
                    <p class="text-sm font-bold text-gray-900">Upload failed</p>
                    <p id="error-message" class="text-xs text-error mt-1">Please try again</p>
                </div>
            </div>
        </div>
        
        <input type="file" id="file-input" class="hidden" accept=".png,.jpg,.jpeg,.pdf">
    </div>
</div>

<!-- CAPTCHA Modal for GST Verification -->
<div id="captchaModal" class="fixed inset-0 bg-gray-900/70 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-3xl animate-slide-in p-6 shadow-2xl">
        <!-- Modal Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-xl font-bold text-gray-900">GST Verification</h3>
                <p class="text-sm text-gray-500 mt-1">Verify GSTIN with government portal</p>
            </div>
            <button onclick="closeCaptchaModal()" class="w-10 h-10 rounded-xl bg-gray-100 text-gray-600 hover:bg-gray-200 hover:text-gray-800 flex items-center justify-center transition-colors">
                <i class="fa-solid fa-times text-lg"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div id="modalContent">
            <!-- Loading State -->
            <div id="loadingState" class="text-center py-8">
                <div class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-primary to-secondary rounded-2xl flex items-center justify-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-2 border-white border-t-transparent"></div>
                </div>
                <p class="text-sm font-medium text-gray-700">Fetching CAPTCHA...</p>
            </div>
            
            <!-- CAPTCHA Form -->
            <div id="captchaForm" class="hidden">
                <div class="mb-4">
                    <label class="text-sm font-bold text-gray-700 mb-2 block">GSTIN</label>
                    <input type="text" id="gstinDisplay" readonly class="w-full px-4 py-3 bg-white/50 border border-white/60 rounded-xl text-sm font-mono text-gray-700">
                </div>
                <div class="mb-4">
                    <label class="text-sm font-bold text-gray-700 mb-2 block">CAPTCHA</label>
                    <div class="bg-white/50 rounded-xl p-4 flex items-center justify-center mb-3">
                        <img id="captchaImage" src="" alt="CAPTCHA" class="max-h-16">
                    </div>
                    <input type="text" id="captchaInput" placeholder="Enter CAPTCHA" class="w-full px-4 py-3 bg-white/50 border border-white/60 rounded-xl text-sm focus:ring-2 focus:ring-primary/20 focus:bg-white/80 transition-all">
                </div>
                <button onclick="submitVerification()" class="w-full py-3 bg-gradient-to-r from-primary to-secondary text-white rounded-xl font-bold hover:shadow-lg transition-all">
                    <i class="fa-solid fa-shield-alt mr-2"></i>Verify GSTIN
                </button>
            </div>
            
            <!-- Result State -->
            <div id="resultState" class="hidden text-center py-8">
                <div id="resultIcon" class="w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center"></div>
                <p id="resultMessage" class="text-sm font-bold text-gray-900"></p>
                <p id="resultDetails" class="text-xs text-gray-500 mt-1"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Upload Modal Logic
    const uploadModal = document.getElementById('upload-modal');
    const uploadBtn = document.getElementById('upload-btn');
    const emptyUploadBtn = document.getElementById('empty-upload-btn');
    const closeModal = document.getElementById('close-modal');
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    
    // Open modal
    function openUploadModal() {
        uploadModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    uploadBtn?.addEventListener('click', openUploadModal);
    emptyUploadBtn?.addEventListener('click', openUploadModal);
    
    // Close modal
    closeModal?.addEventListener('click', function() {
        uploadModal.classList.add('hidden');
        document.body.style.overflow = '';
        resetUploadState();
    });
    
    // Click outside to close
    uploadModal?.addEventListener('click', function(e) {
        if (e.target === uploadModal) {
            uploadModal.classList.add('hidden');
            document.body.style.overflow = '';
            resetUploadState();
        }
    });
    
    // Upload area click
    uploadArea?.addEventListener('click', function() {
        fileInput.click();
    });
    
    // Drag and drop
    uploadArea?.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('border-primary', 'bg-white/30');
    });
    
    uploadArea?.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary', 'bg-white/30');
    });
    
    uploadArea?.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('border-primary', 'bg-white/30');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });
    
    // File input change
    fileInput?.addEventListener('change', function() {
        if (this.files.length > 0) {
            handleFileUpload(this.files[0]);
        }
    });
    
    function handleFileUpload(file) {
        // Validate file type
        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'application/pdf'];
        if (!validTypes.includes(file.type)) {
            showUploadError('Invalid file type. Please upload PNG, JPG, or PDF.');
            return;
        }
        
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            showUploadError('File too large. Maximum size is 10MB.');
            return;
        }
        
        // Show loading state
        document.getElementById('upload-content').classList.add('hidden');
        document.getElementById('upload-loading').classList.remove('hidden');
        
        // Create form data
        const formData = new FormData();
        formData.append('invoice_file', file);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                          document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        
        // Upload file
        fetch('{% url "upload_invoice" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showUploadSuccess();
                setTimeout(() => {
                    window.location.href = '/invoice/' + data.invoice.id + '/';
                }, 1500);
            } else {
                showUploadError(data.error || 'Upload failed. Please try again.');
            }
        })
        .catch(error => {
            showUploadError('Network error. Please try again.');
        });
    }
    
    function showUploadSuccess() {
        document.getElementById('upload-loading').classList.add('hidden');
        document.getElementById('upload-success').classList.remove('hidden');
    }
    
    function showUploadError(message) {
        document.getElementById('upload-loading').classList.add('hidden');
        document.getElementById('upload-content').classList.add('hidden');
        document.getElementById('upload-error').classList.remove('hidden');
        document.getElementById('error-message').textContent = message;
    }
    
    function resetUploadState() {
        document.getElementById('upload-content').classList.remove('hidden');
        document.getElementById('upload-loading').classList.add('hidden');
        document.getElementById('upload-success').classList.add('hidden');
        document.getElementById('upload-error').classList.add('hidden');
        fileInput.value = '';
    }
    
    // GST Verification Logic
    let currentInvoiceId = null;
    let currentGstin = null;
    
    function startVerification(invoiceId, gstin) {
        currentInvoiceId = invoiceId;
        currentGstin = gstin;
        
        document.getElementById('captchaModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Show loading, hide others
        document.getElementById('loadingState').classList.remove('hidden');
        document.getElementById('captchaForm').classList.add('hidden');
        document.getElementById('resultState').classList.add('hidden');
        
        // Fetch CAPTCHA
        fetchCaptcha();
    }
    
    function closeCaptchaModal() {
        document.getElementById('captchaModal').classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    function fetchCaptcha() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                          document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        
        fetch('{% url "request_captcha" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('gstinDisplay').value = currentGstin;
                    document.getElementById('captchaImage').src = data.captchaImage;
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('captchaForm').classList.remove('hidden');
                    // Store session ID for verification
                    window.currentSessionId = data.sessionId;
                } else {
                    showVerificationResult(false, 'Failed to fetch CAPTCHA', data.error);
                }
            })
            .catch(error => {
                showVerificationResult(false, 'Network error', 'Please try again later');
            });
    }
    
    function submitVerification() {
        const captcha = document.getElementById('captchaInput').value;
        if (!captcha) {
            alert('Please enter the CAPTCHA');
            return;
        }
        
        document.getElementById('captchaForm').classList.add('hidden');
        document.getElementById('loadingState').classList.remove('hidden');
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                          document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        
        fetch('{% url "verify_gst" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                invoice_id: currentInvoiceId,
                gstin: currentGstin,
                captcha: captcha,
                session_id: window.currentSessionId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showVerificationResult(true, 'GSTIN Verified', data.business_name || 'Verification successful');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showVerificationResult(false, 'Verification Failed', data.error);
            }
        })
        .catch(error => {
            showVerificationResult(false, 'Network error', 'Please try again later');
        });
    }
    
    function showVerificationResult(success, message, details) {
        document.getElementById('loadingState').classList.add('hidden');
        document.getElementById('captchaForm').classList.add('hidden');
        document.getElementById('resultState').classList.remove('hidden');
        
        const icon = document.getElementById('resultIcon');
        if (success) {
            icon.className = 'w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center bg-success/10';
            icon.innerHTML = '<i class="fa-solid fa-check-circle text-3xl text-success"></i>';
        } else {
            icon.className = 'w-16 h-16 mx-auto mb-4 rounded-2xl flex items-center justify-center bg-error/10';
            icon.innerHTML = '<i class="fa-solid fa-times-circle text-3xl text-error"></i>';
        }
        
        document.getElementById('resultMessage').textContent = message;
        document.getElementById('resultDetails').textContent = details;
    }
</script>
<!-- CSRF Token -->
{% csrf_token %}
{% endblock %}
